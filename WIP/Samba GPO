#!/bin/bash

# GPO Generator para Samba AD-DC
# IntegraÃ§Ã£o com o sistema existente de compartilhamentos

# FunÃ§Ã£o para gerar UUID Ãºnico
generate_uuid() {
    if command -v uuidgen >/dev/null 2>&1; then
        uuidgen | tr '[:lower:]' '[:upper:]'
    else
        # Fallback manual se uuidgen nÃ£o estiver disponÃ­vel
        cat /proc/sys/kernel/random/uuid | tr '[:lower:]' '[:upper:]'
    fi
}

# FunÃ§Ã£o para obter domÃ­nio
get_domain() {
    DOMAIN=$(samba-tool domain info 127.0.0.1 2>/dev/null | grep -i "domain.*:" | head -1 | cut -d: -f2 | tr -d ' ' | tr '[:lower:]' '[:upper:]')
    if [ -z "$DOMAIN" ]; then
        DOMAIN="WORKGROUP"
    fi
    echo "$DOMAIN"
}

# FunÃ§Ã£o para criar estrutura GPO com mapeamento de unidade e atalho
create_gpo_for_share() {
    local share_name="$1"
    local share_path="$2"
    local drive_letter="$3"
    local target_groups="$4"
    local create_shortcut="$5"  # yes/no
    
    if [ -z "$share_name" ] || [ -z "$drive_letter" ]; then
        echo "Erro: Nome do compartilhamento e letra da unidade sÃ£o obrigatÃ³rios"
        return 1
    fi
    
    # Validar letra da unidade
    if ! [[ "$drive_letter" =~ ^[A-Z]$ ]]; then
        echo "Erro: Letra da unidade deve ser uma Ãºnica letra maiÃºscula (A-Z)"
        return 1
    fi
    
    local domain_name=$(get_domain)
    local gpo_uuid=$(generate_uuid)
    local gpo_name="MAP_${share_name}_${drive_letter}"
    local server_name=$(hostname | tr '[:lower:]' '[:upper:]')
    
    echo "ğŸ¯ CRIANDO GPO PARA COMPARTILHAMENTO"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "ğŸ“‚ Compartilhamento: $share_name"
    echo "ğŸ—‚ï¸ Caminho: $share_path"
    echo "ğŸ’¿ Letra da unidade: $drive_letter:"
    echo "ğŸ‘¥ Grupos alvo: $target_groups"
    echo "ğŸ”— Criar atalho: $create_shortcut"
    echo "ğŸ†” UUID da GPO: $gpo_uuid"
    echo "ğŸ“‹ Nome da GPO: $gpo_name"
    echo "ğŸŒ Servidor: $server_name"
    echo "ğŸ¢ DomÃ­nio: $domain_name"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    
    # Criar diretÃ³rio da GPO
    local gpo_path="/var/lib/samba/sysvol/${domain_name}/Policies/{${gpo_uuid}}"
    
    echo "ğŸ“ Criando estrutura de diretÃ³rios..."
    mkdir -p "$gpo_path"
    mkdir -p "$gpo_path/Machine/Preferences/Drives"
    mkdir -p "$gpo_path/Machine/Preferences/Shortcuts"
    mkdir -p "$gpo_path/User/Preferences/Drives"
    mkdir -p "$gpo_path/User/Preferences/Shortcuts"
    
    # 1. CRIAR GPT.INI
    echo "ğŸ“ Criando GPT.INI..."
    cat > "$gpo_path/GPT.INI" << EOF
[General]
Version=65536
displayName=$gpo_name
gPCMachineExtensionNames=[{00000000-0000-0000-0000-000000000000}{CAB54552-DEEA-4691-817E-ED4A4D1AFC72}][{AADCED64-746C-4633-A97C-D61349046527}{CAB54552-DEEA-4691-817E-ED4A4D1AFC72}]
gPCUserExtensionNames=[{00000000-0000-0000-0000-000000000000}{CAB54552-DEEA-4691-817E-ED4A4D1AFC72}][{AADCED64-746C-4633-A97C-D61349046527}{CAB54552-DEEA-4691-817E-ED4A4D1AFC72}]
EOF
    
    # 2. CRIAR DRIVES.XML (Mapeamento de unidade)
    echo "ğŸ’¿ Criando mapeamento de unidade..."
    cat > "$gpo_path/User/Preferences/Drives/Drives.xml" << EOF
<?xml version="1.0" encoding="utf-8"?>
<Drives clsid="{8FDDCC1A-0C3C-43cd-A6B4-71A6DF20DA8C}">
    <Drive clsid="{935D1B74-9CB8-4e3c-9914-7DD559B7A417}" name="$drive_letter:" status="$drive_letter:" image="2" changed="$(date -u +%Y-%m-%d\ %H:%M:%S)" uid="{$(generate_uuid)}">
        <Properties action="C" thisDrive="NOCHANGE" allDrives="NOCHANGE" userName="" path="\\\\$server_name\\$share_name" label="$share_name" persistent="1" useLetter="1" letter="$drive_letter"/>
        <Filters>
            <FilterGroup bool="AND" not="0" name="$domain_name\\$target_groups" sid="" userContext="1" primaryGroup="0" localGroup="0"/>
        </Filters>
    </Drive>
</Drives>
EOF
    
    # 3. CRIAR SHORTCUTS.XML (Atalho no desktop) - SE SOLICITADO
    if [ "$create_shortcut" = "yes" ]; then
        echo "ğŸ”— Criando atalho no desktop..."
        cat > "$gpo_path/User/Preferences/Shortcuts/Shortcuts.xml" << EOF
<?xml version="1.0" encoding="utf-8"?>
<Shortcuts clsid="{725D6BBD-4F67-4b83-9C80-BFDE8D7C2140}">
    <Shortcut clsid="{4F2F7C99-3B94-4f5d-8264-E5EB88F5EDE1}" name="$share_name" status="$share_name" image="0" changed="$(date -u +%Y-%m-%d\ %H:%M:%S)" uid="{$(generate_uuid)}">
        <Properties action="C" targetType="FILESYSTEM" targetPath="\\\\$server_name\\$share_name" arguments="" startIn="" comment="Atalho para $share_name" iconIndex="0" iconPath="%SystemRoot%\\system32\\shell32.dll" shortcutKey="0" window="1"/>
        <Filters>
            <FilterGroup bool="AND" not="0" name="$domain_name\\$target_groups" sid="" userContext="1" primaryGroup="0" localGroup="0"/>
        </Filters>
    </Shortcut>
</Shortcuts>
EOF
    fi
    
    # 4. APLICAR PERMISSÃ•ES CORRETAS
    echo "ğŸ” Aplicando permissÃµes..."
    chmod -R 755 "$gpo_path"
    chown -R root:root "$gpo_path"
    
    # 5. REGISTRAR GPO NO SAMBA
    echo "ğŸ“‹ Registrando GPO no Active Directory..."
    
    # Criar entrada LDAP para a GPO
    ldbedit_script="/tmp/create_gpo_${gpo_uuid}.ldif"
    
    cat > "$ldbedit_script" << EOF
dn: CN={$gpo_uuid},CN=Policies,CN=System,DC=${domain_name//.*/},DC=${domain_name/*./}
objectClass: top
objectClass: container
objectClass: groupPolicyContainer
cn: {$gpo_uuid}
displayName: $gpo_name
flags: 0
gPCFileSysPath: \\\\$server_name\\sysvol\\$domain_name\\Policies\\{$gpo_uuid}
gPCFunctionalityVersion: 2
gPCMachineExtensionNames: [{00000000-0000-0000-0000-000000000000}{CAB54552-DEEA-4691-817E-ED4A4D1AFC72}][{AADCED64-746C-4633-A97C-D61349046527}{CAB54552-DEEA-4691-817E-ED4A4D1AFC72}]
gPCUserExtensionNames: [{00000000-0000-0000-0000-000000000000}{CAB54552-DEEA-4691-817E-ED4A4D1AFC72}][{AADCED64-746C-4633-A97C-D61349046527}{CAB54552-DEEA-4691-817E-ED4A4D1AFC72}]
gPCVersionDirectory: 0
versionNumber: 65536
EOF
    
    # Aplicar no LDAP
    if ldbmodify -H /var/lib/samba/private/sam.ldb "$ldbedit_script" 2>/dev/null; then
        echo "âœ… GPO registrada com sucesso no Active Directory"
    else
        echo "âš ï¸ Falha ao registrar GPO no AD - tentando mÃ©todo alternativo..."
        
        # MÃ©todo alternativo usando samba-tool
        samba-tool gpo create "$gpo_name" 2>/dev/null || echo "âš ï¸ Aviso: GPO pode precisar ser vinculada manualmente"
    fi
    
    # Limpar arquivo temporÃ¡rio
    rm -f "$ldbedit_script"
    
    # 6. RECARREGAR CONFIGURAÃ‡Ã•ES DO SAMBA
    echo "ğŸ”„ Recarregando configuraÃ§Ãµes..."
    smbcontrol all reload-config 2>/dev/null
    
    echo ""
    echo "ğŸ‰ GPO CRIADA COM SUCESSO!"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "ğŸ“Š RESUMO DA GPO:"
    echo "   ğŸ†” UUID: {$gpo_uuid}"
    echo "   ğŸ“‹ Nome: $gpo_name"
    echo "   ğŸ“‚ Compartilhamento: \\\\$server_name\\$share_name"
    echo "   ğŸ’¿ Mapeamento: Unidade $drive_letter:"
    echo "   ğŸ‘¥ Filtro de seguranÃ§a: $target_groups"
    echo "   ğŸ”— Atalho no desktop: $create_shortcut"
    echo "   ğŸ“ Caminho GPO: $gpo_path"
    echo ""
    echo "ğŸ“‹ PRÃ“XIMOS PASSOS:"
    echo "   1ï¸âƒ£ Vincular GPO Ã  OU desejada via RSAT ou samba-tool"
    echo "   2ï¸âƒ£ Configurar filtro de seguranÃ§a se necessÃ¡rio"
    echo "   3ï¸âƒ£ Executar 'gpupdate /force' nos clientes"
    echo ""
    echo "ğŸ”§ COMANDOS ÃšTEIS:"
    echo "   â€¢ Listar GPOs: samba-tool gpo listall"
    echo "   â€¢ Vincular GPO: samba-tool gpo setlink <OU> {$gpo_uuid}"
    echo "   â€¢ Testar GPO: gpresult /r (no cliente)"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    return 0
}

# FunÃ§Ã£o para listar GPOs existentes
list_gpos() {
    echo "ğŸ“‹ LISTANDO GPOS EXISTENTES"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    if command -v samba-tool >/dev/null 2>&1; then
        samba-tool gpo listall 2>/dev/null || echo "âš ï¸ Erro ao listar GPOs"
    else
        echo "âŒ samba-tool nÃ£o encontrado"
    fi
    
    echo ""
    echo "ğŸ“ GPOS NO SISTEMA DE ARQUIVOS:"
    local domain_name=$(get_domain)
    local sysvol_path="/var/lib/samba/sysvol/${domain_name}/Policies"
    
    if [ -d "$sysvol_path" ]; then
        for gpo_dir in "$sysvol_path"/{*}; do
            if [ -d "$gpo_dir" ] && [[ "$(basename "$gpo_dir")" =~ ^\{.*\}$ ]]; then
                local gpo_uuid=$(basename "$gpo_dir")
                local gpt_ini="$gpo_dir/GPT.INI"
                
                if [ -f "$gpt_ini" ]; then
                    local display_name=$(grep "displayName=" "$gpt_ini" | cut -d= -f2-)
                    echo "   ğŸ†” $gpo_uuid"
                    echo "   ğŸ“‹ Nome: ${display_name:-"(sem nome)"}"
                    
                    # Verificar se tem mapeamento de drives
                    if [ -f "$gpo_dir/User/Preferences/Drives/Drives.xml" ]; then
                        local drive_letter=$(grep -o 'letter="[A-Z]"' "$gpo_dir/User/Preferences/Drives/Drives.xml" | cut -d'"' -f2)
                        local share_path=$(grep -o 'path="[^"]*"' "$gpo_dir/User/Preferences/Drives/Drives.xml" | cut -d'"' -f2)
                        echo "   ğŸ’¿ Mapeia: $drive_letter: â†’ $share_path"
                    fi
                    
                    # Verificar se tem atalhos
                    if [ -f "$gpo_dir/User/Preferences/Shortcuts/Shortcuts.xml" ]; then
                        echo "   ğŸ”— Cria atalhos no desktop"
                    fi
                    
                    echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                fi
            fi
        done
    else
        echo "âŒ DiretÃ³rio sysvol nÃ£o encontrado: $sysvol_path"
    fi
}

# FunÃ§Ã£o para remover GPO
remove_gpo() {
    local gpo_uuid="$1"
    
    if [ -z "$gpo_uuid" ]; then
        echo "âŒ Erro: UUID da GPO Ã© obrigatÃ³rio"
        return 1
    fi
    
    # Remover chaves se necessÃ¡rio
    gpo_uuid=$(echo "$gpo_uuid" | sed 's/[{}]//g')
    
    local domain_name=$(get_domain)
    local gpo_path="/var/lib/samba/sysvol/${domain_name}/Policies/{${gpo_uuid}}"
    
    echo "ğŸ—‘ï¸ REMOVENDO GPO"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "ğŸ†” UUID: {$gpo_uuid}"
    echo "ğŸ“ Caminho: $gpo_path"
    echo ""
    
    if [ -d "$gpo_path" ]; then
        echo "ğŸ“ Removendo arquivos da GPO..."
        rm -rf "$gpo_path"
        echo "âœ… Arquivos removidos com sucesso"
    else
        echo "âš ï¸ DiretÃ³rio da GPO nÃ£o encontrado"
    fi
    
    # Tentar remover do AD
    echo "ğŸ“‹ Removendo entrada do Active Directory..."
    if samba-tool gpo del "{$gpo_uuid}" 2>/dev/null; then
        echo "âœ… GPO removida do Active Directory"
    else
        echo "âš ï¸ Falha ao remover do AD - pode precisar ser removida manualmente"
    fi
    
    echo "ğŸ”„ Recarregando configuraÃ§Ãµes..."
    smbcontrol all reload-config 2>/dev/null
    
    echo "âœ… RemoÃ§Ã£o concluÃ­da!"
}

# FunÃ§Ã£o para validar dependÃªncias
check_dependencies() {
    echo "ğŸ” VERIFICANDO DEPENDÃŠNCIAS"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    local missing_deps=()
    
    # Verificar samba-tool
    if ! command -v samba-tool >/dev/null 2>&1; then
        missing_deps+=("samba-tool")
    else
        echo "âœ… samba-tool encontrado"
    fi
    
    # Verificar ldbmodify
    if ! command -v ldbmodify >/dev/null 2>&1; then
        missing_deps+=("ldbmodify")
    else
        echo "âœ… ldbmodify encontrado"
    fi
    
    # Verificar uuidgen
    if ! command -v uuidgen >/dev/null 2>&1; then
        echo "âš ï¸ uuidgen nÃ£o encontrado - usando /proc/sys/kernel/random/uuid"
    else
        echo "âœ… uuidgen encontrado"
    fi
    
    # Verificar diretÃ³rio sysvol
    local domain_name=$(get_domain)
    local sysvol_path="/var/lib/samba/sysvol/${domain_name}"
    
    if [ -d "$sysvol_path" ]; then
        echo "âœ… DiretÃ³rio sysvol encontrado: $sysvol_path"
    else
        echo "âŒ DiretÃ³rio sysvol nÃ£o encontrado: $sysvol_path"
        missing_deps+=("sysvol")
    fi
    
    if [ ${#missing_deps[@]} -eq 0 ]; then
        echo ""
        echo "ğŸ‰ Todas as dependÃªncias estÃ£o satisfeitas!"
        return 0
    else
        echo ""
        echo "âŒ DEPENDÃŠNCIAS FALTANDO:"
        for dep in "${missing_deps[@]}"; do
            echo "   â€¢ $dep"
        done
        return 1
    fi
}

# FunÃ§Ã£o principal para criar compartilhamento com GPO
create_share_with_gpo() {
    local share_name="$1"
    local share_path="$2"
    local share_users="$3"
    local drive_letter="$4"
    local create_shortcut="$5"
    local writable="${6:-yes}"
    local browsable="${7:-yes}"
    
    echo "ğŸš€ CRIANDO COMPARTILHAMENTO COM GPO"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    # 1. Criar compartilhamento normal primeiro
    echo "ğŸ“‚ Passo 1: Criando compartilhamento..."
    
    # ValidaÃ§Ãµes
    if [[ $share_name = *" "* ]] || [[ $share_path = *" "* ]] || [[ $share_name = "" ]]; then
        echo "âŒ Erro: NÃ£o crie compartilhamentos com espaÃ§os nos nomes ou nomes vazios!"
        return 1
    fi
    
    if [ -f "/etc/samba/external/smb.conf.d/$share_name.conf" ]; then
        echo "âŒ Erro: Um compartilhamento com este nome jÃ¡ existe na rede!"
        return 1
    fi
    
    # Criar estrutura se nÃ£o existir
    mkdir -p /etc/samba/external/smb.conf.d/
    mkdir -p "/mnt$share_path"
    
    # Criar arquivo de configuraÃ§Ã£o do compartilhamento
    cat > "/etc/samba/external/smb.conf.d/$share_name.conf" << EOF
[$share_name]
path = /mnt$share_path
valid users = $share_users
admin users = $share_users
writable = $writable
browsable = $browsable
guest ok = no
create mask = 0777
force create mode = 0777
directory mask = 0777
force directory mode = 0777
EOF
    
    # Aplicar permissÃµes
    chmod 777 "/mnt$share_path"
    
    # Revalidar compartilhamentos
    find /etc/samba/external/smb.conf.d/ -type f -print | sed -e 's/^/include = /' > /etc/samba/external/includes.conf
    smbcontrol all reload-config 2>/dev/null
    
    echo "âœ… Compartilhamento criado com sucesso!"
    echo ""
    
    # 2. Criar GPO
    echo "ğŸ“‹ Passo 2: Criando GPO..."
    create_gpo_for_share "$share_name" "$share_path" "$drive_letter" "$share_users" "$create_shortcut"
    
    echo ""
    echo "ğŸ‰ COMPARTILHAMENTO COM GPO CRIADO COM SUCESSO!"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "ğŸ“Š RESUMO COMPLETO:"
    echo "   ğŸ“‚ Compartilhamento: $share_name"
    echo "   ğŸ“ Caminho local: /mnt$share_path"
    echo "   ğŸŒ Caminho de rede: \\\\$(hostname)\\$share_name"
    echo "   ğŸ‘¥ UsuÃ¡rios: $share_users"
    echo "   ğŸ’¿ Unidade mapeada: $drive_letter:"
    echo "   ğŸ”— Atalho desktop: $create_shortcut"
    echo "   âœï¸ GravÃ¡vel: $writable"
    echo "   ğŸ‘ï¸ NavegÃ¡vel: $browsable"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
}

# Menu principal (integraÃ§Ã£o com sistema existente)
main_menu_gpo() {
    echo ""
    echo "ğŸ¯ GPO GENERATOR PARA SAMBA AD-DC"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "1. Verificar dependÃªncias"
    echo "2. Criar compartilhamento com GPO"
    echo "3. Criar GPO para compartilhamento existente"
    echo "4. Listar GPOs existentes"
    echo "5. Remover GPO"
    echo "6. Sair"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -n "Escolha uma opÃ§Ã£o: "
    
    read -r option
    case $option in
        1)
            check_dependencies
            read -p "Pressione Enter para continuar..."
            main_menu_gpo
            ;;
        2)
            echo ""
            echo "ğŸ“‚ CRIAR COMPARTILHAMENTO COM GPO"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            read -p "Nome do compartilhamento: " share_name
            read -p "Caminho (/mnt): " share_path
            read -p "UsuÃ¡rios/grupos (ex: @grupo, usuario): " share_users
            read -p "Letra da unidade (A-Z): " drive_letter
            read -p "Criar atalho no desktop? (yes/no): " create_shortcut
            read -p "GravÃ¡vel? (yes/no) [yes]: " writable
            read -p "NavegÃ¡vel? (yes/no) [yes]: " browsable
            
            writable=${writable:-yes}
            browsable=${browsable:-yes}
            
            create_share_with_gpo "$share_name" "$share_path" "$share_users" "$drive_letter" "$create_shortcut" "$writable" "$browsable"
            read -p "Pressione Enter para continuar..."
            main_menu_gpo
            ;;
        3)
            echo ""
            echo "ğŸ“‹ CRIAR GPO PARA COMPARTILHAMENTO EXISTENTE"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            read -p "Nome do compartilhamento: " share_name
            read -p "Caminho do compartilhamento: " share_path
            read -p "Letra da unidade (A-Z): " drive_letter
            read -p "Grupos alvo: " target_groups
            read -p "Criar atalho no desktop? (yes/no): " create_shortcut
            
            create_gpo_for_share "$share_name" "$share_path" "$drive_letter" "$target_groups" "$create_shortcut"
            read -p "Pressione Enter para continuar..."
            main_menu_gpo
            ;;
        4)
            list_gpos
            read -p "Pressione Enter para continuar..."
            main_menu_gpo
            ;;
        5)
            echo ""
            echo "ğŸ—‘ï¸ REMOVER GPO"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            read -p "UUID da GPO (com ou sem chaves): " gpo_uuid
            
            if [ -n "$gpo_uuid" ]; then
                echo ""
                echo "âš ï¸ ATENÃ‡ÃƒO: Esta aÃ§Ã£o Ã© irreversÃ­vel!"
                read -p "Tem certeza que deseja remover a GPO $gpo_uuid? (yes/no): " confirm
                
                if [ "$confirm" = "yes" ]; then
                    remove_gpo "$gpo_uuid"
                else
                    echo "âŒ OperaÃ§Ã£o cancelada"
                fi
            else
                echo "âŒ UUID nÃ£o fornecido"
            fi
            
            read -p "Pressione Enter para continuar..."
            main_menu_gpo
            ;;
        6)
            echo "ğŸ‘‹ Saindo..."
            exit 0
            ;;
        *)
            echo "âŒ OpÃ§Ã£o invÃ¡lida!"
            main_menu_gpo
            ;;
    esac
}

# Verificar se Ã© chamada direta ou integraÃ§Ã£o
if [ "$1" = "--menu" ]; then
    main_menu_gpo
elif [ "$1" = "--create-gpo" ]; then
    shift
    create_gpo_for_share "$@"
elif [ "$1" = "--create-share-gpo" ]; then
    shift
    create_share_with_gpo "$@"
elif [ "$1" = "--list" ]; then
    list_gpos
elif [ "$1" = "--remove" ]; then
    remove_gpo "$2"
elif [ "$1" = "--check" ]; then
    check_dependencies
else
    echo "ğŸ¯ GPO Generator para Samba AD-DC"
    echo ""
    echo "Uso:"
    echo "  $0 --menu                                    # Menu interativo"
    echo "  $0 --create-gpo <nome> <caminho> <letra> <grupos> <atalho>"
    echo "  $0 --create-share-gpo <nome> <caminho> <usuarios> <letra> <atalho> [gravavel] [navegavel]"
    echo "  $0 --list                                    # Listar GPOs"
    echo "  $0 --remove <uuid>                          # Remover GPO"
    echo "  $0 --check                                   # Verificar dependÃªncias"
    echo ""
    echo "Exemplos:"
    echo "  $0 --create-gpo \"Vendas\" \"/vendas\" \"V\" \"@Vendas\" \"yes\""
    echo "  $0 --create-share-gpo \"Marketing\" \"/marketing\" \"@Marketing,joao\" \"M\" \"no\" \"yes\" \"yes\""
fi
